<!-- HTML header for doxygen 1.9.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" class="dark-mode">
<head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=11"/>
    <meta name="generator" content="Doxygen 1.9.6"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta property="og:title" content="MRAS: MRAS code to a Beginner">
    <meta property="og:image" content="https://mras.sunride.space/sunride_logo.png">
    <meta property="og:description" content="Multi Rocket Avionics System">
    <meta name="theme-color" content="#EE3437">
    <title>MRAS: MRAS code to a Beginner</title>
    <link href="tabs.css" rel="stylesheet" type="text/css"/>
    <link rel="shortcut icon" href="sunride_rocket.ico" type="image/x-icon"/>
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="dynsections.js"></script>
    <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
    <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
    <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
    <link href="doxygen.css" rel="stylesheet" type="text/css"/>
    <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
    <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
            <table cellspacing="0" cellpadding="0">
                <tbody>
                <tr id="projectrow">
                    <td id="projectlogo"><img alt="Logo" src="sunride_logo.png"/></td>
                    <td id="projectalign">
                        <div id="projectname">MRAS
                        </div>
                        <div id="projectbrief">Multi Rocket Avionics System</div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_docs_BeginnerExplanation.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">MRAS code to a Beginner </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h4><a class="anchor" id="autotoc_md19"></a>
â€“ Author: Nikilesh Ramesh</h4>
<p>These explain a few concepts that I found difficult to grasp as new member looking into MRAS codebase. Intentionally used informal tone to format it like a conversation rather than a reference material.</p>
<h1><a class="anchor" id="autotoc_md20"></a>
System Message Explanation</h1>
<p>MRAS system is split into sub-systems with each subsytem talking to each other with messages, specifically system messages (<code><a class="el" href="classSystemMessage.html" title="A base class for all system messages.">SystemMessage</a></code>). The second most popular word among Sunride software team-members is sub-system, the first being message. So before we explore the sub-systems it's important to understand the messaging infrastructure.</p>
<p>The <code><a class="el" href="SystemMessage_8h_source.html">SystemMessage.h</a></code> includes a enum <code>SystemMessageType</code> which contains all the <b>types</b> that the <code><a class="el" href="classSystemMessage.html" title="A base class for all system messages.">SystemMessage</a></code> can be like barometer data, accelerometer data etc. These data are named using this format <code>{Name of Source}DataMsg_t</code>. So for example baromoter message is named as <code>BarometerDataMsg_t</code>. This is strictly for other classes to diffrentiate message types and is <b>NOT</b> an actual <em>data type</em> in c++ context, an example use case is lets say you only want the environmental data, you would only care about the barometer output so you can use a <code>switch</code> statement to only print out the message <b>if</b> its of the type <code>BarometerDataMsg_t</code>. Since they are contained within an enum each "message type" expands to an int. The acutal <em>data type</em> (in c++ context) is formatted as <code>{Name of Source}DataMsg</code>, an example would be <code><a class="el" href="structBarometerDataMsg.html" title="Message sent by the barometer to the system.">BarometerDataMsg</a></code> (the undersore t is dropped).</p>
<p>Now lets understand <code><a class="el" href="structBarometerDataMsg.html" title="Message sent by the barometer to the system.">BarometerDataMsg</a></code>. This is its definition: </p><div class="fragment"><div class="line"><span class="keyword">struct </span><a class="code hl_struct" href="structBarometerDataMsg.html">BarometerDataMsg</a> : <span class="keyword">public</span> <a class="code hl_class" href="classSystemMessage.html">SystemMessage</a> {</div>
<div class="line"><span class="keyword">explicit</span> <a class="code hl_struct" href="structBarometerDataMsg.html">BarometerDataMsg</a>() : <a class="code hl_class" href="classSystemMessage.html">SystemMessage</a>(BarometerDataMsg_t) {}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">float</span> <a class="code hl_variable" href="structBarometerDataMsg.html#afb566492391d1960c024830531af8ce2">pressure</a> = 0;</div>
<div class="line"><span class="keywordtype">float</span> <a class="code hl_variable" href="structBarometerDataMsg.html#aa9d229c021a03c1201068fcf29381f5b">temperature</a> = 0;</div>
<div class="line">};</div>
<div class="ttc" id="aclassSystemMessage_html"><div class="ttname"><a href="classSystemMessage.html">SystemMessage</a></div><div class="ttdoc">A base class for all system messages.</div><div class="ttdef"><b>Definition:</b> SystemMessage.h:31</div></div>
<div class="ttc" id="astructBarometerDataMsg_html"><div class="ttname"><a href="structBarometerDataMsg.html">BarometerDataMsg</a></div><div class="ttdoc">Message sent by the barometer to the system.</div><div class="ttdef"><b>Definition:</b> BarometerDataMsg.h:15</div></div>
<div class="ttc" id="astructBarometerDataMsg_html_aa9d229c021a03c1201068fcf29381f5b"><div class="ttname"><a href="structBarometerDataMsg.html#aa9d229c021a03c1201068fcf29381f5b">BarometerDataMsg::temperature</a></div><div class="ttdeci">float temperature</div><div class="ttdoc">The temperature in degrees Celsius.</div><div class="ttdef"><b>Definition:</b> BarometerDataMsg.h:26</div></div>
<div class="ttc" id="astructBarometerDataMsg_html_afb566492391d1960c024830531af8ce2"><div class="ttname"><a href="structBarometerDataMsg.html#afb566492391d1960c024830531af8ce2">BarometerDataMsg::pressure</a></div><div class="ttdeci">float pressure</div><div class="ttdoc">The pressure in Pa.</div><div class="ttdef"><b>Definition:</b> BarometerDataMsg.h:21</div></div>
</div><!-- fragment --><p> As you can see it's a <code>struct</code>, in C++, structs are their own "data type" so each subsystem <b>class</b> has a struct that is the message it would "send" and the data type is the name of the struct. Let's break this down line-by-line. In the first line the <code>:</code> operator suggests that it inherits from another <b>class</b> *(structs == class in c++, with different default behaviour <a href="https://stackoverflow.com/questions/3574040/c-can-a-struct-inherit-from-a-class">more here</a>)* <code><a class="el" href="classSystemMessage.html" title="A base class for all system messages.">SystemMessage</a></code>. In the second line you can find <code>:</code> operator combined with constructors, here it simply means we are calling (explicitly) the constructor of <code><a class="el" href="classSystemMessage.html" title="A base class for all system messages.">SystemMessage</a></code>. <code>BarometerDataMsg_t</code> that is parsed into the constructor simply acts as an ID for the message. Then you have the acutal content of the message/struct.</p>
<p>Detour to <code><a class="el" href="classSystemMessage.html" title="A base class for all system messages.">SystemMessage</a></code>, the reason why it exists (in my opinion) is to enforce the use of the messaging infrastructure and mainly as a placeholder for when the messages are <b>published</b>. Emphasis on publish, as the <code><a class="el" href="classSystemMessage.html" title="A base class for all system messages.">SystemMessage</a></code> is "published" to all of its "subscribers", subscribers are other sub-systems that require this message. Like a newspaper/magazine, <code><a class="el" href="classSystemMessage.html" title="A base class for all system messages.">SystemMessage</a></code> is the newspaper/magazine, the sub-systems are the publishing house and you are the sub-systems that recieves the message. Now that you have recieved it, you have a lot of data that you may or may not want, if you are like me you might only want to look at pictures so <code><a class="el" href="classSystemMessage.html" title="A base class for all system messages.">SystemMessage</a></code> class provides a neat way of sorting it. Here's an example:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="classStateEstimator.html#a84539a2ef749162404087d8398d77aad">StateEstimator::on_message</a>(<a class="code hl_class" href="classSystemMessage.html">SystemMessage</a> *msg)</div>
<div class="line">{</div>
<div class="line"><span class="keywordflow">if</span> (msg-&gt;<a class="code hl_function" href="classSystemMessage.html#a52115712bcb3591a2054dff75932279a">get_type</a>() == BarometerDataMsg_t)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">auto</span> Nmsg = (<a class="code hl_struct" href="structBarometerDataMsg.html">BarometerDataMsg</a> *) msg;</div>
<div class="line">    log(<span class="stringliteral">&quot;Estimated altitude: %f&quot;</span>, altitudeEstimate(Nmsg));</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="ttc" id="aclassStateEstimator_html_a84539a2ef749162404087d8398d77aad"><div class="ttname"><a href="classStateEstimator.html#a84539a2ef749162404087d8398d77aad">StateEstimator::on_message</a></div><div class="ttdeci">void on_message(SystemMessage *msg) override</div><div class="ttdef"><b>Definition:</b> StateEstimator.cpp:44</div></div>
<div class="ttc" id="aclassSystemMessage_html_a52115712bcb3591a2054dff75932279a"><div class="ttname"><a href="classSystemMessage.html#a52115712bcb3591a2054dff75932279a">SystemMessage::get_type</a></div><div class="ttdeci">SystemMessageType get_type()</div><div class="ttdoc">Get the type of the message.</div><div class="ttdef"><b>Definition:</b> SystemMessage.h:40</div></div>
</div><!-- fragment --><p>The <code><a class="el" href="classStateEstimator.html">StateEstimator</a></code> class recieves a catalogue of information everytime a sub-system publishes, the <code><a class="el" href="classSystemMessage.html" title="A base class for all system messages.">SystemMessage</a></code> but it only needs the barometer reading so it can simply use the function <code>get_type()</code> in an if statement to filter out the barometer data. <br  />
</p>
<h1><a class="anchor" id="autotoc_md21"></a>
Subsystem Explanation</h1>
<p>Now we talk about the sub-systems themselves. There are two types of them in MRAS, Message Handlers and Non-Message Handlers. As I understand it any sub-system that recieves and proccesses the messages is deemed message handlers and the sub-systems that only publish are non-message handlers. So the sensors fall under non-handlers and data logging systems fall under handlers.</p>
<p>The <code>MRAS_system</code> is the highest level of control in MRAS. It keeps track of all the sub-systems and the paradigm is to operate all the others through the <code>MRAS_system</code>. For example: </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> main() {</div>
<div class="line"><a class="code hl_class" href="classTextLogger.html">TextLogger</a>* logger = <span class="keyword">new</span> <a class="code hl_class" href="classNativeTextLogger.html">NativeTextLogger</a>(0);</div>
<div class="line"><a class="code hl_class" href="classMRAS__System.html">MRAS_System</a>* mras = <a class="code hl_function" href="classMRAS__System.html#a07cf9d005ca99766edd263fb5ab8d2c7">MRAS_System::get_instance</a>();</div>
<div class="line"> </div>
<div class="line"><span class="keyword">auto</span> *accelerometer = <span class="keyword">new</span> <a class="code hl_class" href="classFakeAccelerometer.html">FakeAccelerometer</a>(1);</div>
<div class="line"><span class="keyword">auto</span> *data_logger = <span class="keyword">new</span> <a class="code hl_class" href="classNativeDataLogger.html">NativeDataLogger</a>(2);</div>
<div class="line"><span class="keyword">auto</span> *barometer = <span class="keyword">new</span> <a class="code hl_class" href="classFakeBarometer.html">FakeBarometer</a>(3);</div>
<div class="line"><span class="keyword">auto</span> *altitudeEstimator = <span class="keyword">new</span> <a class="code hl_class" href="classStateEstimator.html">StateEstimator</a>(4);</div>
<div class="line"> </div>
<div class="line">mras-&gt;<a class="code hl_function" href="classMRAS__System.html#a41ff4dddee056619595cca54573728a6">set_logger</a>(logger);</div>
<div class="line">mras-&gt;<a class="code hl_function" href="classMRAS__System.html#aa59711a03276ece5fcb27c8b64d3d9aa">add_subsystem</a>(accelerometer);</div>
<div class="line">mras-&gt;<a class="code hl_function" href="classMRAS__System.html#aa59711a03276ece5fcb27c8b64d3d9aa">add_subsystem</a>(barometer);</div>
<div class="line">mras-&gt;<a class="code hl_function" href="classMRAS__System.html#aa59711a03276ece5fcb27c8b64d3d9aa">add_subsystem</a>(altitudeEstimator);</div>
<div class="line"> </div>
<div class="line">accelerometer-&gt;add_subscriber(data_logger);</div>
<div class="line">barometer-&gt;add_subscriber(data_logger);</div>
<div class="line">barometer-&gt;add_subscriber(altitudeEstimator);</div>
<div class="line">altitudeEstimator-&gt;add_subscriber(data_logger);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">mras-&gt;setup();</div>
<div class="line"> </div>
<div class="line">mras-&gt;loop();</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="aclassFakeAccelerometer_html"><div class="ttname"><a href="classFakeAccelerometer.html">FakeAccelerometer</a></div><div class="ttdoc">A fake accelerometer for testing.</div><div class="ttdef"><b>Definition:</b> FakeAccelerometer.h:17</div></div>
<div class="ttc" id="aclassFakeBarometer_html"><div class="ttname"><a href="classFakeBarometer.html">FakeBarometer</a></div><div class="ttdef"><b>Definition:</b> FakeBarometer.h:8</div></div>
<div class="ttc" id="aclassMRAS__System_html"><div class="ttname"><a href="classMRAS__System.html">MRAS_System</a></div><div class="ttdoc">The main class of the MRAS system.</div><div class="ttdef"><b>Definition:</b> MRAS_System.h:18</div></div>
<div class="ttc" id="aclassMRAS__System_html_a07cf9d005ca99766edd263fb5ab8d2c7"><div class="ttname"><a href="classMRAS__System.html#a07cf9d005ca99766edd263fb5ab8d2c7">MRAS_System::get_instance</a></div><div class="ttdeci">static MRAS_System * get_instance()</div><div class="ttdef"><b>Definition:</b> MRAS_System.cpp:9</div></div>
<div class="ttc" id="aclassMRAS__System_html_a41ff4dddee056619595cca54573728a6"><div class="ttname"><a href="classMRAS__System.html#a41ff4dddee056619595cca54573728a6">MRAS_System::set_logger</a></div><div class="ttdeci">void set_logger(TextLogger *logger)</div><div class="ttdoc">Set the TextLogger that is used to log messages.</div><div class="ttdef"><b>Definition:</b> MRAS_System.cpp:53</div></div>
<div class="ttc" id="aclassMRAS__System_html_aa59711a03276ece5fcb27c8b64d3d9aa"><div class="ttname"><a href="classMRAS__System.html#aa59711a03276ece5fcb27c8b64d3d9aa">MRAS_System::add_subsystem</a></div><div class="ttdeci">bool add_subsystem(Subsystem *subsystem)</div><div class="ttdoc">Add a Subsystem to the system.</div><div class="ttdef"><b>Definition:</b> MRAS_System.cpp:16</div></div>
<div class="ttc" id="aclassNativeDataLogger_html"><div class="ttname"><a href="classNativeDataLogger.html">NativeDataLogger</a></div><div class="ttdoc">A subsystem that logs SystemMessages using its log() function, mostly for debugging.</div><div class="ttdef"><b>Definition:</b> NativeDataLogger.h:14</div></div>
<div class="ttc" id="aclassNativeTextLogger_html"><div class="ttname"><a href="classNativeTextLogger.html">NativeTextLogger</a></div><div class="ttdoc">A TextLogger that is compatible with the Native MRAS build environment.</div><div class="ttdef"><b>Definition:</b> NativeTextLogger.h:20</div></div>
<div class="ttc" id="aclassStateEstimator_html"><div class="ttname"><a href="classStateEstimator.html">StateEstimator</a></div><div class="ttdef"><b>Definition:</b> StateEstimator.h:8</div></div>
<div class="ttc" id="aclassTextLogger_html"><div class="ttname"><a href="classTextLogger.html">TextLogger</a></div><div class="ttdoc">A base class for ArduinoTextLogger and NativeTextLogger.</div><div class="ttdef"><b>Definition:</b> TextLogger.h:18</div></div>
</div><!-- fragment --><p> In this <code>main()</code> we first define all the subsytems with unique IDs. And then call <code>add_subsytem</code> on <code>mras</code> to setup <code>mras</code> to track all the subsytems. Now when <code>setup()</code> and <code>loop()</code> is called on <code>mras</code> it's also called on every other subsystem that was added.</p>
<h1><a class="anchor" id="autotoc_md22"></a>
Steps to make your own Sub-system:</h1>
<ol type="1">
<li>Determine if your subsystem is a message handler or not</li>
<li>Accordingly implement the class. For non-message handlers a <code>SUBSYSTEM_NO_MESSAGE_HANDLER</code> (it simply is a macro that implements an empty <code>on_message()</code> method) is added towards at the end of the class (check out <em><a href="https://mras.sunride.space/md_docs_subsystem_implementation_guide.html">How to implement a Subsytem</a></em>)</li>
<li>Add your system message type to the <code>SystemMessageType</code></li>
<li>Now add the struct that defines your sub-system's message in the <code>system_messages</code> folder.</li>
<li>Now add your sub-system as subscriber to any other sub-system if needed</li>
<li>Finally add your sub-system to <code>mras</code> like found above.</li>
<li>Take a shot everytime you type out "Msg". </li>
</ol>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6 </li>
  </ul>
</div>
</body>
</html>
