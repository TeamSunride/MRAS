<!-- HTML header for doxygen 1.9.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" class="dark-mode">
<head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=11"/>
    <meta name="generator" content="Doxygen 1.9.6"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta property="og:title" content="MRAS: Hardware-In-the-Loop testing in MRAS">
    <meta property="og:image" content="https://mras.sunride.space/sunride_logo.png">
    <meta property="og:description" content="Multi Rocket Avionics System">
    <meta name="theme-color" content="#EE3437">
    <title>MRAS: Hardware-In-the-Loop testing in MRAS</title>
    <link href="tabs.css" rel="stylesheet" type="text/css"/>
    <link rel="shortcut icon" href="sunride_rocket.ico" type="image/x-icon"/>
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="dynsections.js"></script>
    <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
    <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
    <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
    <link href="doxygen.css" rel="stylesheet" type="text/css"/>
    <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
    <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
            <table cellspacing="0" cellpadding="0">
                <tbody>
                <tr id="projectrow">
                    <td id="projectlogo"><img alt="Logo" src="sunride_logo.png"/></td>
                    <td id="projectalign">
                        <div id="projectname">MRAS
                        </div>
                        <div id="projectbrief">Multi Rocket Avionics System</div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_docs_HIL_in_MRAS.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Hardware-In-the-Loop testing in MRAS </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h3><a class="anchor" id="autotoc_md43"></a>
â€“ Nikilesh Ramesh</h3>
<h2><a class="anchor" id="autotoc_md44"></a>
Introduction</h2>
<p>Hardware-In-the-Loop (hereinafter HIL) is a way of testing embedded systems software. Stream simulated data over from either a deicated test rig or a computer to then measure the output to test if the system performs as expected. More information can be found <a href="https://uk.mathworks.com/discovery/hardware-in-the-loop-hil.html">here</a>.</p>
<h2><a class="anchor" id="autotoc_md45"></a>
Simulink Model Explanation</h2>
<p>Simulink is used to test MRAS. Data is streamed over serial to MRAS from the launch data collected during previous flights. Launch data is saved as csv file. <code>From spreadsheet</code> block in Simulink can be used to read the csv file. <em>Note: csv file needs to be formatted as per SIMULINK requirements see <a href="https://uk.mathworks.com/help/simulink/slref/fromspreadsheet.html">here</a></em></p>
<p>The <code>pressure</code> and <code>y_accel</code> (acceleration y direction, up) is then concatenated using the <code>vector concatenate</code> block. They are then casted to floating points with <code>cast to single</code> block. Then <code>Byte pack</code> is used to convert them into bytes.</p>
<p>Simulink's Instument Control blockset provides a neat way of communicating with the board without much restrictions on the software, only a module that can read and write to serial is needed to communicate using this blockeset therfore this was chosen instead of Simulink's Arduino support package.</p>
<p>To send this data, first a <code>Serial Configuration</code> block must be added to the model. Set the baud rate, COM port and other essential details here. Then use <code>Serial Send</code> to stream data over to the board (again set the parameters as required and you are recommened by the author to skip the headers/break section for this block as it does not provide much added value if you are only testing a small system). How this data is proccessed on MRAS will be discussed in the next section.</p>
<p>Now <code>Serial Recieve</code> block provides the interface to read the data that MRAS outputs again in bytes. Configure the parameters as necessary, important parameters include <code>Serial Port</code>, <code>Input</code> and <code>Headers</code> (Headers are recommended here as Simulink deals with it so why not). Then cast to double before using the <code>Mux</code> block to divide the input vector into two values (the order of values depends on how you handle it in MRAS)</p>
<div class="image">
<img src="SimulinkSS.png" alt=""/>
<div class="caption">
Simulink model</div></div>
    <h2><a class="anchor" id="autotoc_md46"></a>
MRAS rocketHIL env Explanation</h2>
<p>On MRAS a new <code>env</code> has been added dedicated for HIL testing named <code>rocketHIL</code>, checkout the <code>platformio.ini</code> and <code>main-rocketHIL.cpp</code> files. A new <code><a class="el" href="classSubsystem.html">Subsystem</a></code> has been added (if you are not familiar with MRAS subsystems you are encouranged to checkout either <a href="https://mras.sunride.space/md_docs_software_architecture_overview.html">Architecture overview</a> or <a href="https://mras.sunride.space/md_docs_BeginnerExplanation.html">a beginner guide to MRAS</a>) to interface with Simulink called <code><a class="el" href="classSimulinkDataLogger.html" title="A subsystem that logs SystemMessages using its log() function, for Simulink.">SimulinkDataLogger</a></code>. It logs recieves data from Simulink, casts it to the appropriate internal <code><a class="el" href="classSystemMessage.html" title="A base class for all system messages.">SystemMessage</a></code>, then "publishes" it. The <code><a class="el" href="classStateEstimator.html">StateEstimator</a></code> (more about this <a href="https://mras.sunride.space/md_docs_state_estimation.html">here</a>)is the sole subscriber to the said message. It proccess this message and then itself publishes a new <code><a class="el" href="structStateEstimatorMsg.html">StateEstimatorMsg</a></code>. <code><a class="el" href="classSimulinkDataLogger.html" title="A subsystem that logs SystemMessages using its log() function, for Simulink.">SimulinkDataLogger</a></code> (it is subscribed to <code><a class="el" href="classStateEstimator.html">StateEstimator</a></code>, thus making a two-way connection) then formats this message into the required format and then writes to Serial.</p>
<p>Well to convert data to bytes and vice-versa is an excellent use-case of <code>Union</code> data type that <code>c++</code> provides. An union is basically a struct but all its members define the same value (recommended watch <a href="https://www.youtube.com/watch?v=6uqU9Y578n4">Cherno</a>).</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">union</span>{</div>
<div class="line">    <span class="keywordtype">float</span> number;</div>
<div class="line">    uint8_t bytes[4];</div>
<div class="line">} <a class="code hl_union" href="unionFLOATUNION__t.html">FLOATUNION_t</a>;</div>
<div class="ttc" id="aunionFLOATUNION__t_html"><div class="ttname"><a href="unionFLOATUNION__t.html">FLOATUNION_t</a></div><div class="ttdef"><b>Definition:</b> SimulinkDataLogger.h:12</div></div>
</div><!-- fragment --><p>Here the <code>float number</code> and <code>uint8_t bytes[4]</code> define the same value. A <code>float</code> is made up of 4 bytes, <code>uint8_t</code> or <code>char</code> type is made of 1 byte, now an array of four <code>char</code> is then 4 bytes. So we can now represent a <code>float</code> as an array of four <code>uint8_t</code>. Then use Arduino framework's <code>Serial.write()</code> to write the <b>bytes</b> but to read it use the <code>Serial.read()</code> into <code>number</code> (c++ automatically changes the <code>bytes</code> array everytime <code>number</code> is re-assigned).</p>
<h2><a class="anchor" id="autotoc_md47"></a>
References</h2>
<p>Best source of reference for the Simulink side of things is the <a href="https://uk.mathworks.com/products/simulink.html">Mathworks Documentation</a>. For the interface there is an excellent <a href="https://github.com/leomariga/Simulink-Arduino-Serial">github repository</a> with examples you can try out. Additionally <a href="https://www.youtube.com/playlist?list=PLlrATfBNZ98dudnM48yfGUldqGD0S4FFb">Cherno's C++ series</a> was helpful. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6 </li>
  </ul>
</div>
</body>
</html>
