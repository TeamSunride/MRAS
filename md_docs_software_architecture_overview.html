<!-- HTML header for doxygen 1.9.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" class="dark-mode">
<head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=11"/>
    <meta name="generator" content="Doxygen 1.9.6"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta property="og:title" content="MRAS: Software Architecture Overview">
    <meta property="og:image" content="https://mras.sunride.space/sunride_logo.png">
    <meta property="og:description" content="Multi Rocket Avionics System">
    <meta name="theme-color" content="#EE3437">
    <title>MRAS: Software Architecture Overview</title>
    <link href="tabs.css" rel="stylesheet" type="text/css"/>
    <link rel="shortcut icon" href="sunride_rocket.ico" type="image/x-icon"/>
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="dynsections.js"></script>
    <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
    <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
    <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
    <link href="doxygen.css" rel="stylesheet" type="text/css"/>
    <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
    <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
            <table cellspacing="0" cellpadding="0">
                <tbody>
                <tr id="projectrow">
                    <td id="projectlogo"><img alt="Logo" src="sunride_logo.png"/></td>
                    <td id="projectalign">
                        <div id="projectname">MRAS
                        </div>
                        <div id="projectbrief">Multi Rocket Avionics System</div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_docs_software_architecture_overview.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Software Architecture Overview </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>As our hardware designs evolve, different sensors and processors will be used, and the software must be written in such a way that these components can be swapped with no issues. In past iterations of the MRAS software, this was achieved with an inheritance based model for different sensors. Each sensor inherited from a standard Sensor class, and a further abstraction layer was used for different types of sensors, such as Barometer, Accelerometer, and so on.</p>
<p>However, after a while it was apparent that this approach does not scale well to other applications. There are more than just Sensors on MRAS, and all of these subsystems need to be managed.</p>
<p>During some initial software design meetings, a message-based system was proposed. Initially this was viewed as overcomplicated and involving too much overhead, however after discovering the issues described above, the team decided to review the software architecture plan.</p>
<p>We decided to split the software up into <code><a class="el" href="classSubsystem.html">Subsystem</a></code>s. These Subsystems can communicate with each other by sending each other messages, which we refer to as <code><a class="el" href="classSystemMessage.html" title="A base class for all system messages.">SystemMessage</a></code>s. All of these Subsystems are managed by one singleton class called <code><a class="el" href="classMRAS__System.html" title="The main class of the MRAS system.">MRAS_System</a></code>. This class manages the setup, status, and state of all the subsystems during the execution of the program.</p>
<div class="image">
<img src="subsystem_architecture.png" alt=""/>
<div class="caption">
MRAS Subsystem Architecture Overview</div></div>
    <p>Shown above are three example subsystems, <code>Accelerometer</code>, <code>Barometer</code>, and <code>DataLogger</code>. The DataLogger is <em>subscribed</em> to the Accelerometer and Barometer, allowing it to receive <code><a class="el" href="structAccelerometerDataMsg.html" title="Message sent by the accelerometer to the system.">AccelerometerDataMsg</a></code> and <code><a class="el" href="structBarometerDataMsg.html" title="Message sent by the barometer to the system.">BarometerDataMsg</a></code> messages.</p>
<p>The <a class="el" href="classSubsystem.html">Subsystem</a> model works quite well with the Arduino software framework. Each <a class="el" href="classSubsystem.html">Subsystem</a> has a setup() and loop() function, which mirrors that of Arduino. Therefore, MRAS can be considered to be made up of loads of small Arduino programs. This makes it easier to scale the software.</p>
<blockquote class="doxtable">
<p>&zwj;It is worth noting here that we only have one thread available. MRAS is currently single-threaded. Therefore, the <code>loop()</code> function within each <a class="el" href="classSubsystem.html">Subsystem</a> must be designed to return almost immediately. No blocking calls to functions such as <code>delay()</code> are allowed. Each <a class="el" href="classSubsystem.html">Subsystem</a> should be thoroughly tested to make sure it is not blocking the operaton of other Subsystems. </p>
</blockquote>
<h1><a class="anchor" id="autotoc_md49"></a>
System Messages</h1>
<div class="image">
<img src="system_message.png" alt=""/>
<div class="caption">
System Messages</div></div>
    <p>System Messages can be implemented as shown above. They inherit from the <code><a class="el" href="classSystemMessage.html" title="A base class for all system messages.">SystemMessage</a></code> base class. A new <code>SystemMessageType</code> must be added to the <code>SystemMessageType</code> enum, corresponding to the name of the new system message. Shown here:</p>
<div class="fragment"><div class="line"><span class="keyword">enum</span> SystemMessageType {</div>
<div class="line">    UNDEFINED_SYSTEM_MESSAGE,</div>
<div class="line">    AccelerometerDataMsg_t,</div>
<div class="line">    HighGAccelerometerDataMsg_t,</div>
<div class="line">    BarometerDataMsg_t,</div>
<div class="line">    GyroDataMsg_t,</div>
<div class="line">    MagnetometerDataMsg_t,</div>
<div class="line">    GNSSDataMsg_t</div>
<div class="line">};</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md50"></a>
MRAS_System</h1>
<p>A pointer to the <a class="el" href="classMRAS__System.html" title="The main class of the MRAS system.">MRAS_System</a> class (accessible globally) can be attained as follows:</p>
<div class="fragment"><div class="line"><a class="code hl_class" href="classMRAS__System.html">MRAS_System</a> *mras = <a class="code hl_function" href="classMRAS__System.html#a07cf9d005ca99766edd263fb5ab8d2c7">MRAS_System::get_instance</a>();</div>
<div class="ttc" id="aclassMRAS__System_html"><div class="ttname"><a href="classMRAS__System.html">MRAS_System</a></div><div class="ttdoc">The main class of the MRAS system.</div><div class="ttdef"><b>Definition:</b> MRAS_System.h:18</div></div>
<div class="ttc" id="aclassMRAS__System_html_a07cf9d005ca99766edd263fb5ab8d2c7"><div class="ttname"><a href="classMRAS__System.html#a07cf9d005ca99766edd263fb5ab8d2c7">MRAS_System::get_instance</a></div><div class="ttdeci">static MRAS_System * get_instance()</div><div class="ttdef"><b>Definition:</b> MRAS_System.cpp:9</div></div>
</div><!-- fragment --><p>Each <a class="el" href="classSubsystem.html">Subsystem</a> needs to be registered with MRAS. This is done as follows:</p>
<div class="fragment"><div class="line">mras-&gt;<a class="code hl_function" href="classMRAS__System.html#aa59711a03276ece5fcb27c8b64d3d9aa">add_subsystem</a>(&amp;data_logger);</div>
<div class="line">mras-&gt;<a class="code hl_function" href="classMRAS__System.html#aa59711a03276ece5fcb27c8b64d3d9aa">add_subsystem</a>(&amp;magnetometer);</div>
<div class="line">mras-&gt;<a class="code hl_function" href="classMRAS__System.html#aa59711a03276ece5fcb27c8b64d3d9aa">add_subsystem</a>(&amp;imu);</div>
<div class="line">mras-&gt;<a class="code hl_function" href="classMRAS__System.html#aa59711a03276ece5fcb27c8b64d3d9aa">add_subsystem</a>(&amp;barometer);</div>
<div class="line">mras-&gt;<a class="code hl_function" href="classMRAS__System.html#aa59711a03276ece5fcb27c8b64d3d9aa">add_subsystem</a>(&amp;accelerometer);</div>
<div class="ttc" id="aclassMRAS__System_html_aa59711a03276ece5fcb27c8b64d3d9aa"><div class="ttname"><a href="classMRAS__System.html#aa59711a03276ece5fcb27c8b64d3d9aa">MRAS_System::add_subsystem</a></div><div class="ttdeci">bool add_subsystem(Subsystem *subsystem)</div><div class="ttdoc">Add a Subsystem to the system.</div><div class="ttdef"><b>Definition:</b> MRAS_System.cpp:16</div></div>
</div><!-- fragment --><p>In the main Arduino program, the <code>setup()</code> and <code>loop()</code> functions of <a class="el" href="classMRAS__System.html" title="The main class of the MRAS system.">MRAS_System</a> need to be called. This allows MRAS to run the <code>setup()</code> and <code>loop()</code> functions for each <a class="el" href="classSubsystem.html">Subsystem</a>.</p>
<div class="fragment"><div class="line">mras-&gt;setup();</div>
<div class="line">mras-&gt;loop();</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md51"></a>
Publishing SystemMessages to other Subsystems</h1>
<p>For this section we will use an example of a Magnetometer. Specifically, <a class="el" href="classSensor__LIS3MDL.html" title="A subsystem for the LIS3MDL magnetometer.">Sensor_LIS3MDL</a>.</p>
<p>Start by creating an instance of a new <a class="el" href="structMagnetometerDataMsg.html" title="Message sent by the magnetometer to the system.">MagnetometerDataMsg</a>:</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> *mag_msg = <span class="keyword">new</span> <a class="code hl_struct" href="structMagnetometerDataMsg.html">MagnetometerDataMsg</a>();</div>
<div class="ttc" id="astructMagnetometerDataMsg_html"><div class="ttname"><a href="structMagnetometerDataMsg.html">MagnetometerDataMsg</a></div><div class="ttdoc">Message sent by the magnetometer to the system.</div><div class="ttdef"><b>Definition:</b> MagnetometerDataMsg.h:17</div></div>
</div><!-- fragment --><p>Now set any fields within the <a class="el" href="classSystemMessage.html" title="A base class for all system messages.">SystemMessage</a> to their desired values (in this case, set the Magnetometer vector to a new reading from the sensor)</p>
<div class="fragment"><div class="line">mag_msg-&gt;mag = (Vector&lt;float, 3&gt;) lis-&gt;get_mag();</div>
</div><!-- fragment --><p>Then publish the <a class="el" href="classSystemMessage.html" title="A base class for all system messages.">SystemMessage</a> to all subscribed subsystems using the <code>publish()</code> function.</p>
<div class="fragment"><div class="line">publish(mag_msg);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md52"></a>
Receiving SystemMessages from other Subsystems</h1>
<p>Each <a class="el" href="classSubsystem.html">Subsystem</a> can override a message handler as shown:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> on_message(<a class="code hl_class" href="classSystemMessage.html">SystemMessage</a> *msg) <span class="keyword">override</span>;</div>
<div class="ttc" id="aclassSystemMessage_html"><div class="ttname"><a href="classSystemMessage.html">SystemMessage</a></div><div class="ttdoc">A base class for all system messages.</div><div class="ttdef"><b>Definition:</b> SystemMessage.h:32</div></div>
</div><!-- fragment --><p>If the <a class="el" href="classSubsystem.html">Subsystem</a> does not need to receive messages, a Macro can be used to skip creating this handler:</p>
<div class="fragment"><div class="line">SUBSYSTEM_NO_MESSAGE_HANDLER</div>
</div><!-- fragment --><p>Within this message handler, a switch statement can be used to receive different types of system messages. Shown below is an example of receiving a <a class="el" href="structMagnetometerDataMsg.html" title="Message sent by the magnetometer to the system.">MagnetometerDataMsg</a>:</p>
<div class="fragment"><div class="line"><span class="keywordflow">switch</span> (msg-&gt;get_type()) {</div>
<div class="line">    <span class="keywordflow">case</span> MagnetometerDataMsg_t: {</div>
<div class="line">        <span class="keyword">auto</span> mag_msg = (<a class="code hl_struct" href="structMagnetometerDataMsg.html">MagnetometerDataMsg</a>*) msg;</div>
<div class="line">        log(<span class="stringliteral">&quot;MagnetometerDataMsg: %f %f %f&quot;</span>,</div>
<div class="line">            mag_msg-&gt;mag[0],</div>
<div class="line">            mag_msg-&gt;mag[1],</div>
<div class="line">            mag_msg-&gt;mag[2]);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6 </li>
  </ul>
</div>
</body>
</html>
