<!-- HTML header for doxygen 1.9.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" class="dark-mode">
<head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=11"/>
    <meta name="generator" content="Doxygen 1.9.6"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta property="og:title" content="MRAS: StateEstimator in MRAS">
    <meta property="og:image" content="https://mras.sunride.space/sunride_logo.png">
    <meta property="og:description" content="Multi Rocket Avionics System">
    <meta name="theme-color" content="#EE3437">
    <title>MRAS: StateEstimator in MRAS</title>
    <link href="tabs.css" rel="stylesheet" type="text/css"/>
    <link rel="shortcut icon" href="sunride_rocket.ico" type="image/x-icon"/>
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="dynsections.js"></script>
    <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
    <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
    <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
    <link href="doxygen.css" rel="stylesheet" type="text/css"/>
    <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
    <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
            <table cellspacing="0" cellpadding="0">
                <tbody>
                <tr id="projectrow">
                    <td id="projectlogo"><img alt="Logo" src="sunride_logo.png"/></td>
                    <td id="projectalign">
                        <div id="projectname">MRAS
                        </div>
                        <div id="projectbrief">Multi Rocket Avionics System</div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_docs_state_estimation.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title"><a class="el" href="classStateEstimator.html">StateEstimator</a> in MRAS </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h3><a class="anchor" id="autotoc_md54"></a>
â€“ Nikilesh Ramesh</h3>
<h2><a class="anchor" id="autotoc_md55"></a>
Introduction</h2>
<p><em>State Estimation as of feb 2023 uses a linear kalman filter, fusing accelerometer and barometer data.</em></p>
<p>A linear kalman filter (also called Linear Quadratic Estimator) is a predictive filter that can be used on a linear model. Since the barometer and accelerometer data have a lot of noise, we could fuse them together to reduce the noise in the system. It can also reveal the hidden state (if designed to), in this case the velocity, as the acceleration to position relation involves a conversion to velocity. The state esitmator uses the linear equations that define acceleration with position: $$ s = u + \frac{1}{2} a {t}^2 \\ v = a t $$ where \( s, v, a and t \) position, velocity, acceleration and time step respectively. These parameters define the state of the system. Accelerometers measure the acceleration and position (altitude) is resolved from the barometer (see <a href="https://mras.sunride.space/md_docs_atmosphere_class_guide.html">Atmosphere</a>). Velocity is a "hidden" state as the system doesn't include a sensor that outputs velocity.</p>
<p>But these are for continous funcitons, \( t \) would be replaced with \( \Delta t \) to discretize it. For ease of computation, these functions need to be in matrix form. But the the function must be decoupled from the measurement so we could update the <code>state</code>.</p>
<p>$$ state = \begin{bmatrix} 1 &amp; dt \\ 0 &amp; 1 \end{bmatrix} \begin{bmatrix} position \\ velocity \end{bmatrix} + \begin{bmatrix} \frac{1}{2} {\Delta t}^2 \\ \Delta t \end{bmatrix} (acceleration + g) $$</p>
<p>where \( g = -9.81 \) which accounts for gravity, as accelerometers don't account for it.</p>
<p>The next important concept for the filter is <code>covariance</code>. As the filter is probablistic it also needs the standard deviation and error data at compile time. This is then used to update the covariance matrix to then keep track of how the error propagates in time.</p>
<p>For more information on the background theory see <a href="https://www.kalmanfilter.net/default.aspx">Kalman Filter</a></p>
<h2><a class="anchor" id="autotoc_md56"></a>
Implementation</h2>
<p>There's 4 files that implements the State Estimation: <code><a class="el" href="StateEstimator_8h_source.html">StateEstimator.h</a></code>, <code>StateEstimator.cpp</code>, <code><a class="el" href="LinearKalmanFilter_8h_source.html">LinearKalmanFilter.h</a></code> and <code>LinearKalmanFilter.cpp</code>. The <code><a class="el" href="classStateEstimator.html">StateEstimator</a></code> class interfaces with the MRAS, it inherits from <code><a class="el" href="classSubsystem.html">Subsystem</a></code> class (see <a href="https://mras.sunride.space/md_docs_software_architecture_overview.html">Software Architecture</a>)</p>
<p><code><a class="el" href="LinearKalmanFilter_8h_source.html">LinearKalmanFilter.h</a></code> is the class that filters the data. It's method include: <code>update(float pressure)</code>, <code>predict(float accel)</code>, <code>get_altitude()</code>, <code>get_velocity()</code> and <code>get_timeStep()</code>.</p>
<div class="image">
<img src="kalmanloop.png" alt=""/>
<div class="caption">
Linear Kalman Filter Loop</div></div>
    <p>The <code>predict()</code> and <code>update()</code> functions correspond to the Predict and Correct block in the diagram above. Initialize block is excuted in the constructor of <code><a class="el" href="classLinearKalmanFilter.html">LinearKalmanFilter</a></code> class. The constructor takes in three floats: time step, acceleration standard deviation and altimeter standard deviation.</p>
<p><b>NOTE: THE TIME STEP IS THE MOST IMPORTANT PARAMETER HERE, IT HAS TO MATCH THE SAMPLING TIME EXACTLY ELSE THE RESULTS ARE UNUSABLE</b></p>
<div class="fragment"><div class="line"><a class="code hl_class" href="classLinearKalmanFilter.html">LinearKalmanFilter</a> Filter(<span class="keywordtype">float</span> dt, <span class="keywordtype">float</span> accelSTD, <span class="keywordtype">float</span> altimeterSTD);</div>
<div class="ttc" id="aclassLinearKalmanFilter_html"><div class="ttname"><a href="classLinearKalmanFilter.html">LinearKalmanFilter</a></div><div class="ttdef"><b>Definition:</b> LinearKalmanFilter.h:6</div></div>
</div><!-- fragment --><p>The <code>predict()</code> and <code>update()</code> methods implement the filter algorithm by using <a href="https://eigen.tuxfamily.org/index.php?title=Main_Page">Eigen</a>. Specifically the <a href="https://github.com/bolderflight/eigen">borderflight/eigen</a></p>
<p>The <code><a class="el" href="classStateEstimator.html">StateEstimator</a></code> class has four methods; three of the inherited methods from <code><a class="el" href="classSubsystem.html">Subsystem</a></code> class: <code>setup()</code>, <code>loop()</code> and <code>on_message()</code> and one extra method <code>altitudeEstimate()</code> which outputs the altitude just from the barometer.</p>
<ol type="1">
<li><code>LinearKalmanfilter</code> is initialized in the <code>setup()</code></li>
<li>The <code>on_message(SystemMessage *msg)</code> sorts the incoming messages for the <code><a class="el" href="structBarometerDataMsg.html" title="Message sent by the barometer to the system.">BarometerDataMsg</a></code> and <code><a class="el" href="structAccelerometerDataMsg.html" title="Message sent by the accelerometer to the system.">AccelerometerDataMsg</a></code> then copies it to a member variable</li>
<li><code>loop()</code> handles the filtering and publishing the data </li>
</ol>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6 </li>
  </ul>
</div>
</body>
</html>
